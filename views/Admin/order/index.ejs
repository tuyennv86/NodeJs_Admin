<!DOCTYPE html>
<html>
  <head>
    <% include ../../partials/backend/partialLink %> 
    <% include ../../partials/backend/partialCsript %>
  </head>
  <body> 
<% include ../../partials/backend/aside %> 
<div id="right-panel" class="right-panel">
<% include ../../partials/backend/header %>

<div class="breadcrumbs">
    <div class="col-sm-4">
        <div class="page-header float-left">
            <div class="page-title">
                <h1>Danh sách đơn hàng</h1>
            </div>
        </div>
    </div>
    <div class="col-sm-8">
        <div class="page-header float-right">
            <div class="page-title">
                <ol class="breadcrumb text-right">
                    <li><a href="index">Trang chủ</a></li>                  
                    <li class="active"><a href="/admin/order/index">Danh sách các đơn hàng</a></li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="content mt-3">
    <div class="animated fadeIn">
            
         <div class="card">
                    <div class="card-header">
                        <div class="col col-md-6">                       
                         <form action="/admin/order/search" method="POST" class="form-horizontal">
                            <div class="input-group">
                                    <select class="form-control col-md-3 form-control-sm" id="status" name="status" style="width:200px;">
                                        <option <%= status == '0' ? 'selected' : ''%> value="0">Tất cả</option>
                                        <option <%= status == '1' ? 'selected' : ''%> value="1">Chờ xác nhận</option>
                                        <option <%= status == '2' ? 'selected' : ''%> value="2">Đang giao</option>
                                        <option <%= status == '3' ? 'selected' : ''%> value="3">Đã nhận</option>
                                        <option <%= status == '4' ? 'selected' : ''%> value="4">Đã hủy</option>
                                    </select>                                       
                                    <input type="text" class="form-control col-md-5 form-control-sm" name="textsearch" id="textsearch" value="<%= searchVal %>" placeholder="Nhập từ khóa tìm kiếm...">
                                    <span class="input-group-btn">
                                    <button class="btn btn-info btn-sm" type="submit"><i class="fa fa-search fa-fw"></i> Tìm kiếm</button>
                                    </span>
                            </div>
                        </form>  
                        </div>
                        <form action="/admin/order/index/<%= current %>" method="POST" class="form-horizontal">
                        <div class="col-12 col-md-6">
                                <div class="float-right">
                                    <a href="/admin/order/add" class="btn btn-success btn-sm" style="color: #fff;">
                                        <i class="fa fa-plus"></i> Thêm mới
                                    </a>                                      
                                    <button type="button" class="btn btn-danger btn-sm" id="bntdeleteList" disabled>
                                            <i class="fa fa-trash-o"></i> Xóa tin được chọn
                                        </button>                                   
                                </div>
                        </div>
                        
                    </div>
                    <div class="card-body">
                     <% include ../../partials/backend/messages %>                       
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col"><input type="checkbox" id="checkAll"></th>
                                    <th scope="col">Họ tên</th>
                                    <th scope="col">Địa chỉ</th>                                  
                                    <th scope="col">Số điện thoại</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Tổng tiền</th> 
                                    <th scope="col">Ngày đặt</th>   
                                    <th scope="col">Trạng thái</th>   
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>
                           <% data.forEach(item => { %>
                             <tr class="toggle">
                                    <td scope="row"><input type="checkbox" name="checkItem" class="checkItem" value="<%= item._id %>"></td>
                                    <td><%= item.fullName %><br></td> 
                                    <td> <%= item.address %> </td>                                    
                                    <td><%= item.phone %></td>
                                    <td><%= item.email %></td>
                                    <td style="font-weight: 600; color: #C82333;"><%= item.totalFormat %></td>
                                    <td><%= item.createDateIso %></td>  
                                    <td>
                                        <% item.orderStatus.forEach(el => { %>
                                            <span style="color: red;"> <%= el.statusName %></span><br>
                                        <% }) %>
                                    </td>                                 
                                    <td>
                                        <% if(item.status == 2){%>
                                        <div class="float-right">
                                            <select class="form-control form-control-sm" id="slStatus">                                                
                                                <option value="<%= item._id %>-3">Đã nhận hàng</option>
                                                <option value="<%= item._id %>-4">Hủy đơn hàng</option>
                                            </select> <a class="btn btn-primary btn-sm" href="#" id="bntUpdate"><i class="fa fa-wrench"></i>&nbsp; Cập nhật</a> </div>
                                            <%}else if(item.status == 1){ %>
                                                <div class="float-right">
                                            <select class="form-control form-control-sm" id="slStatus">  
                                                <option value="<%= item._id %>-2">Đang giao hàng</option>                                              
                                                <option value="<%= item._id %>-3">Đã nhận hàng</option>
                                                <option value="<%= item._id %>-4">Hủy đơn hàng</option>
                                            </select> <a class="btn btn-primary btn-sm" href="#" id="bntUpdate"><i class="fa fa-wrench"></i>&nbsp; Cập nhật</a></div>
                                            <% } %>
                                    </td>
                                </tr>
                              <% item.products.forEach(pro => { %>
                                <tr style="display: none;" class="toggle-more">
                                    <td colspan="2">  <img src="<%= pro.product.ImageUrlFull %>" class="align-self-center" alt="<%= item.productName %>" style="width:50px; height:50px;"> </td>
                                    <td colspan="4"><a href="/admin/product/index?search=<%= pro.product.productName %>&cateid=1"><%= pro.product.productName %></a><br><i style="color: teal;">Số lượng : <%= pro.qunantity %></i></td>
                                    <td colspan="3"><span style="text-decoration: line-through; color: #BDB6A8;"><%= pro.product.priceOldFormat %></span><br> <span style="color: #FF6C00"><%= pro.product.priceFormat %></span></td>
                                </tr> 
                                <% }) %>
                           <% }) %>
                                                          
                            </tbody>
                        </table>
                      <% include ../../partials/backend/PageNavigation %>
                    </div>                    
            </div>
            </form>
        </div>
    </div>
</div>

</div>
<script>
jQuery(document).ready(function($) {
    
    var showText='+ Chi tiết đơn hàng';
    var hideText='- Ẩn chi tiết';

    $('.toggle td:nth-child(2)').wrapInner('<a href="#" class="toggleLink" />');
    $('.toggleLink').append( ' <span class="showtext">'+showText+'</span>' );   
    $('.toggle-more').closest('tr').hide();
    $('a.toggleLink').click(function() {
        var showTextSpan = $(this).find('.showtext');
        showTextSpan.html((showTextSpan.html() == hideText) ? showText : hideText);
        $(this).closest('tr').nextUntil('tr:not(.toggle-more)').toggle();
        return false; 
    });

     $("#bntUpdate").click(function(){
         var list = $(this).prev().val();
        event.preventDefault(); 
        bootbox.confirm("Bạn có cập nhật trạng thái không ?", function (result) {
            if(result == true){
                
                $.ajax({
                    type: "GET",
                    async: true,
                    url: "/admin/order/updateStatus/"+list,        
                    cache: true,
                    dataType: "json",
                    success: function (done) {                        
                        if(done.status){ 
                            bootbox.alert(done.message, function(){ 
                                location.reload(true);
                            });               
                        }else{
                            bootbox.alert(done.message);
                        }
                    }
                });
                
            }
        })
     });   

    $('#bntdeleteList').click(function() {
        event.preventDefault(); 
        bootbox.confirm("Bạn có chắc chắn XÓA các bản tin đã chọn không ?", function (result) {
            if (result == true) {
                var listId = '';
                $(".table tbody input[name='checkItem']:checked").each(function() {                   
                    listId += $(this).val()+',';
                });
                $.ajax({
                type: "GET",
                async: true,
                url: "/admin/order/deleteMultil/"+listId,        
                cache: true,
                dataType: "json",
                success: function (done) {                        
                    if(done.status){ 
                        bootbox.alert(done.message, function(){ 
                            location.reload(true);
                        });               
                    }else{
                        bootbox.alert(done.message);
                    }
                }
                });
            }
        });       

    });
    

});

</script>
</body>
</html>