<!DOCTYPE html>
<html>
  <head>
    <% include ../../partials/backend/partialLink %>     
    <% include ../../partials/backend/partialCsript %> 
  </head>
  <body> 
<% include ../../partials/backend/aside %> 
<div id="right-panel" class="right-panel">
<% include ../../partials/backend/header %>

<div class="breadcrumbs">
    <div class="col-sm-4">
        <div class="page-header float-left">
            <div class="page-title">
                <h1>Sửa menu : <%= data.Name %> </h1>
            </div>
        </div>
    </div>
    <div class="col-sm-8">
        <div class="page-header float-right">
            <div class="page-title">
                <ol class="breadcrumb text-right">
                    <li><a href="index">Trang chủ</a></li>                  
                    <li class="active">Chỉnh sửa menu</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="content mt-3">
    <div class="animated fadeIn">
         <div class="card">
                    <div class="card-header">
                <strong>Chỉnh sửa menu</strong> 
            </div>
            <div class="card-body card-block">
            <% include ../../partials/backend/messages %>                       
                <form action="/admin/menu/edit/<%= data._id %>" method="post" enctype="multipart/form-data" class="form-horizontal form-validate" id="ud">                    
                <input type="hidden" value="<%= data._id%>" name="id" id="id">                    
                <input type="hidden" value="<%= data.category%>" name="category" id="category">
                  <div class="row form-group">
                        <div class="col col-md-3"><label class="form-control-label">Link ngoài:</label></div>
                        <div class="col-12 col-md-9 mserro">
                            <div class="form-check">
                                <div class="checkbox">
                                    <label for="chkOutLink" class="form-check-label ">
                                        <input type="checkbox" id="chkOutLink" name="chkOutLink" class="form-check-input" <% if(data.outLink) { %> checked="checkbox" <%}%>> Link Ngoài
                                    </label>
                                </div>  
                            </div> 
                        </div>
                    </div>
                  
                    <div class="row form-group" id="divlinkout" <% if(!data.outLink) { %> style="display: none;" <%}%>>
                        <div class="col col-md-3"><label class="form-control-label">Link Url:</label></div>
                        <div class="col-12 col-md-9 mserro"><input type="text" id="linkUrl" name="linkUrl" placeholder="Nhập link liên kết Url" class="form-control" data-rule-required="true" value="<%= data.linkUrl %>" <% if(!data.outLink) { %> disabled <%}%>></div>
                    </div> 
                    <div class="row form-group" id="divchungloai" <% if(data.outLink) { %> style="display: none;" <%}%>>
                        <div class="col col-md-3"><label for="categoryType" class="form-control-label">Chọn chủng loại :</label></div>
                        <div class="col-12 col-md-9 mserro">
                        <select name="categoryType" id="categoryType" class="standardSelect form-control" data-rule-required="true">
                        <% listType.forEach(item => { %>
                        <option value="<%= item._id %>" <%if(item._id.equals(data.categoryType)){ %> selected <% }%> ><%= item.typeName %></option>
                        <% }) %>                            
                        <select>
                        </div>
                    </div>  
                    <div class="row form-group" id="divdanhmuc" <% if(data.outLink) { %> style="display: none;" <%}%>>
                        <div class="col col-md-3"><label for="parent" class="form-control-label">Chọn danh mục :</label></div>
                        <div class="col-12 col-md-9 mserro">
                        <select name="slCategory" id="slCategory" class="form-control" data-placeholder="Chọn danh mục..." data-rule-required="true" style="width: 100%;">

                        <select>
                        </div>
                    </div>  
                    <div class="row form-group">
                        <div class="col col-md-3"><label for="parent" class="form-control-label">Chọn mục cha :</label></div>
                        <div class="col-12 col-md-9 mserro">
                        <select name="parent" id="parent" class="form-control" data-placeholder="Chọn mục cha...">
                            <option value="">Root</option>
                            <%- include('../../partials/backend/menuTree', {items: listmenu, level: 1, id_check: data.parent }) %>                          
                        <select>
                        </div>
                    </div>  
                    <div class="row form-group">
                        <div class="col col-md-3"><label class="form-control-label">Tên menu:</label></div>
                        <div class="col-12 col-md-9 mserro"><input type="text" id="name" name="name" placeholder="Nhập tên menu" class="form-control" data-rule-required="true" value="<%= data.Name %>"></div>
                    </div>                   
                     <div class="row form-group">
                        <div class="col col-md-3"><label class=" form-control-label">Thứ tự</label></div>
                        <div class="col-12 col-md-9 mserro"><input type="text" id="order" name="order" placeholder="Nhập thứ tự sản phẩm" class="form-control" data-rule-required="true" data-rule-number="true" value="<%= data.order %>"></div>
                    </div>
                    <div class="row form-group">
                        <div class="col col-md-3"><label class=" form-control-label">Vị trí</label></div>
                        <div class="col-12 col-md-9 mserro">
                        <select name="slOption" id="slOption" class="form-control"  multiple="multiple" data-placeholder="Chọn vị trí" data-rule-required="true">
                        <option value="1" <% if(data.position.includes("1")){ %> selected <%}%>>Top</option>
                            <option value="2" <% if(data.position.includes("2")){ %> selected <%}%>>Left</option>
                            <option value="3" <% if(data.position.includes("3")){ %> selected <%}%>>Right</option>
                            <option value="4" <% if(data.position.includes("4")){ %> selected <%}%>>Bottom</option>
                        <select>
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col col-md-3"> &nbsp; </div>
                            <div class="col col-md-9">
                                <div class="form-check">
                                    <div class="checkbox">
                                        <label for="chkActive" class="form-check-label ">
                                            <input type="checkbox" id="chkActive" name="chkActive" class="form-check-input" <% if(data.active) { %> checked="checkbox" <%}%>> Active
                                        </label>
                                    </div>                        
                                </div>
                            </div>
                        </div>
                         <div class="row form-group">
                        <div class="col col-md-3">&nbsp;</div>
                        <div class="col-12 col-md-9"><button type="submit" id="bntAdd" class="btn btn-primary btn-sm"><i class="fa fa-refresh"></i> Cập nhật</button>
                        <a href="/admin/menu/Index" class="btn btn-danger btn-sm"><i class="fa fa-reply"></i> Quay lại</a> </div>
                    </div> 
                    
                </form>
            </div>            
        </div>
    </div>
</div>

</div>


<script type="text/javascript">

    jQuery(document).ready(function($) {   
        
        $('#slCategory').select2({
            placeholder: 'Chọn 1 danh mục',
            allowClear: true
        });
        $('#parent').select2({
            placeholder: 'Chọn menu cha',
            allowClear: true
        });
        $("#slOption").select2({
            placeholder: 'Chọn các vị trí menu',
            allowClear: true                          
        });
        $("#chkOutLink").change(function () {
            if (this.checked){ 
                $('#divlinkout').show();
                $("#linkUrl").removeAttr("disabled");
                $("#divchungloai").hide();
                $("#divdanhmuc").hide();
            }
            else{ 
                $('#divlinkout').hide();
                $("#linkUrl").attr('disabled','disabled');
                $("#divchungloai").show();
                $("#divdanhmuc").show();
            }
        });
        var cateId = $("#category").val();
        $.ajax({
            type: "GET",
            async: true,        
            url: "/api/category/getparentAndCategoryInMenuOtherCateId/"+$("#categoryType option:selected").val()+"/"+ cateId,        
            cache: false,
            dataType: "json",
            success: function (done) {                 
                if(done.status){
                    if(done.status){ 
                        $("#slCategory").html(listCate(done.data, done.listmenu, true, 1, cateId));      
                    }     
                }
            }
        });

        $('#categoryType').on('change', function() {
            $.ajax({
                type: "GET",
                async: true,        
                url: "/api/category/getparentAndCategoryInMenuOtherCateId/"+$("#categoryType option:selected").val()+"/"+ cateId,        
                cache: false,
                dataType: "json",
                success: function (done) {                
                    if(done.status){ 
                        $("#slCategory").html(listCate(done.data, done.listmenu, true, 1, cateId));      
                    }
                }
            });
        });

});

function listCate(list, arrCate, isChild, level, cate_id){   
    var html;
    if(isChild){
         html ='';
    }
    list.forEach(function(item){
        var space = "";
        for(var j = 1 ;j< level; j++ ){
            space = space + "--";
        }        
        var disString = '';
        if(arrCate.includes(item._id)){
            disString = 'disabled="disabled"'
        }
        var activeSelect ='';
        if(item._id == cate_id){
            activeSelect = 'selected'                    
        }
        html +='<option value="'+item._id+'"'+disString+ activeSelect+'>'+space+item.categoryName+'</option>';
        if(item.children.length > 0 ){
           html += listCate(item.children, arrCate, false, level + 1, cate_id);           
        }
    })  
    return html;
}  
</script>


</body>
</html>